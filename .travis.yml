language: cpp
dist: trusty

addons:
  apt:
    sources:
      - llvm-toolchain-trusty-7
      - ubuntu-toolchain-r-test  
    packages:
      - libc6-dev-i386
      - linux-libc-dev
      - gcc-multilib
      - g++-multilib
      - clang-7
      - llvm-dev
os:
  - linux
  - osx
  
before_script:
  - sed -i.bak "s/unspecified_hash/$(git rev-parse HEAD 2>/dev/null)/g;s/unspecified_author/$(git log --pretty="%ae" -1 2>/dev/null)/g;s/0000/$(git rev-list HEAD --count 2>/dev/null)/g" include/resource.h && rm include/resource.h.bak

script:
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then cd project && CC=clang-7 && make all; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then cd project && CC=clang && make all; fi

after_success:
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then curl --ftp-create-dirs -T ./release/yapb.so -u $FTP_USER:$FTP_PASS ftp://$FTP_HOST/project/release/yapb.so && curl --ftp-create-dirs -T ./debug/yapb.so -u $FTP_USER:$FTP_PASS ftp://$FTP_HOST/project/debug/yapb.so && curl -X GET "https://yapb.ru/agent/packager.php?key=$PACKAGER_KEY&os=linux"; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then curl --ftp-create-dirs -T ./release/yapb.dylib -u $FTP_USER:$FTP_PASS ftp://$FTP_HOST/project/release/yapb.dylib && curl --ftp-create-dirs -T ./debug/yapb.dylib -u $FTP_USER:$FTP_PASS ftp://$FTP_HOST/project/debug/yapb.dylib && curl -X GET "https://yapb.ru/agent/packager.php?key=$PACKAGER_KEY&os=osx"; fi
  
